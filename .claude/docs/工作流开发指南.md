# å·¥ä½œæµå¼€å‘æŒ‡å—

> **é‡è¦æç¤º**: æœ¬é¡¹ç›®æ˜¯ RuoYi-Vue-Plus **çº¯åç«¯é¡¹ç›®**ï¼Œé‡‡ç”¨**ä¸‰å±‚æ¶æ„**ã€‚
> å·¥ä½œæµæ¨¡å—åŸºäº **WarmFlow** å®ç°ï¼Œæä¾›æµç¨‹å®šä¹‰ã€æµç¨‹å®ä¾‹ã€ä»»åŠ¡ç®¡ç†ç­‰åŠŸèƒ½ã€‚

æœ€åæ›´æ–°: 2026-02-09

---

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„

### æ¨¡å—ä¿¡æ¯

| é¡¹ç›® | è§„èŒƒ |
|------|------|
| **æ¨¡å—ä½ç½®** | `ruoyi-modules/ruoyi-workflow/` |
| **åŒ…è·¯å¾„** | `org.dromara.workflow` |
| **è¡¨å‰ç¼€** | `flow_` |
| **æ¶æ„** | ä¸‰å±‚ï¼šController â†’ Service â†’ Mapperï¼ˆæ—  DAO å±‚ï¼‰ |
| **å·¥ä½œæµå¼•æ“** | WarmFlow |

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Controller Layer                           â”‚
â”‚  FlwTaskController | FlwInstanceController | FlwDefinitionController
â”‚  FlwCategoryController | FlwSpelController | TestLeaveController â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Service Layer                             â”‚
â”‚  FlwTaskService | FlwInstanceService | FlwDefinitionService     â”‚
â”‚  FlwCategoryService | FlwSpelService | TestLeaveService         â”‚
â”‚                              â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚           WarmFlow Core (FlowEngine)                         â”‚â”‚
â”‚  â”‚   TaskService | InsService | DefService | NodeService        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Mapper Layer                              â”‚
â”‚  FlwCategoryMapper | FlwSpelMapper | TestLeaveMapper            â”‚
â”‚  FlwInstanceMapper | FlwTaskMapper | FlwInstanceBizExtMapper    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Listener & Handler                             â”‚
â”‚  WorkflowGlobalListener (ä»»åŠ¡ç›‘å¬) | FlowProcessEventHandler (äº‹ä»¶å‘å¸ƒ)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ¨¡å—ç›®å½•ç»“æ„

```
ruoyi-modules/ruoyi-workflow/src/main/java/org/dromara/workflow/
â”œâ”€â”€ controller/
â”‚   â”œâ”€â”€ FlwTaskController.java         # ä»»åŠ¡ç®¡ç†
â”‚   â”œâ”€â”€ FlwInstanceController.java     # å®ä¾‹ç®¡ç†
â”‚   â”œâ”€â”€ FlwDefinitionController.java   # æµç¨‹å®šä¹‰
â”‚   â”œâ”€â”€ FlwCategoryController.java     # æµç¨‹åˆ†ç±»
â”‚   â”œâ”€â”€ FlwSpelController.java         # SpELè¡¨è¾¾å¼
â”‚   â””â”€â”€ TestLeaveController.java       # è¯·å‡ç¤ºä¾‹
â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ IFlwTaskService.java
â”‚   â”œâ”€â”€ IFlwInstanceService.java
â”‚   â”œâ”€â”€ IFlwDefinitionService.java
â”‚   â”œâ”€â”€ IFlwCategoryService.java
â”‚   â”œâ”€â”€ IFlwSpelService.java
â”‚   â”œâ”€â”€ IFlwTaskAssigneeService.java
â”‚   â”œâ”€â”€ IFlwNodeExtService.java
â”‚   â”œâ”€â”€ IFlwCommonService.java
â”‚   â”œâ”€â”€ ITestLeaveService.java
â”‚   â””â”€â”€ impl/
â”‚       â”œâ”€â”€ FlwTaskServiceImpl.java
â”‚       â”œâ”€â”€ FlwInstanceServiceImpl.java
â”‚       â”œâ”€â”€ FlwDefinitionServiceImpl.java
â”‚       â”œâ”€â”€ FlwCategoryServiceImpl.java
â”‚       â”œâ”€â”€ FlwSpelServiceImpl.java
â”‚       â”œâ”€â”€ FlwTaskAssigneeServiceImpl.java
â”‚       â”œâ”€â”€ FlwNodeExtServiceImpl.java
â”‚       â”œâ”€â”€ FlwCommonServiceImpl.java
â”‚       â”œâ”€â”€ TestLeaveServiceImpl.java
â”‚       â””â”€â”€ WorkflowServiceImpl.java   # é€šç”¨å·¥ä½œæµæœåŠ¡
â”œâ”€â”€ mapper/                            # Mapper å±‚ï¼ˆé DAOï¼‰
â”‚   â”œâ”€â”€ FlwCategoryMapper.java
â”‚   â”œâ”€â”€ FlwSpelMapper.java
â”‚   â”œâ”€â”€ FlwTaskMapper.java
â”‚   â”œâ”€â”€ FlwInstanceMapper.java
â”‚   â”œâ”€â”€ FlwInstanceBizExtMapper.java
â”‚   â””â”€â”€ TestLeaveMapper.java
â”œâ”€â”€ listener/
â”‚   â””â”€â”€ WorkflowGlobalListener.java    # å…¨å±€ç›‘å¬å™¨
â”œâ”€â”€ handler/
â”‚   â”œâ”€â”€ FlowProcessEventHandler.java   # äº‹ä»¶å‘å¸ƒ
â”‚   â””â”€â”€ WorkflowPermissionHandler.java # æƒé™å¤„ç†
â”œâ”€â”€ rule/
â”‚   â””â”€â”€ SpelRuleComponent.java         # SpEL è§„åˆ™ç»„ä»¶
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ FlowCategory.java
â”‚   â”œâ”€â”€ FlowSpel.java
â”‚   â”œâ”€â”€ FlowInstanceBizExt.java
â”‚   â”œâ”€â”€ TestLeave.java
â”‚   â”œâ”€â”€ bo/                            # ä¸šåŠ¡å¯¹è±¡
â”‚   â”‚   â”œâ”€â”€ StartProcessBo.java
â”‚   â”‚   â”œâ”€â”€ CompleteTaskBo.java
â”‚   â”‚   â”œâ”€â”€ BackProcessBo.java
â”‚   â”‚   â”œâ”€â”€ TaskOperationBo.java
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ vo/                            # è§†å›¾å¯¹è±¡
â”‚       â”œâ”€â”€ FlowTaskVo.java
â”‚       â”œâ”€â”€ FlowHisTaskVo.java
â”‚       â”œâ”€â”€ FlowInstanceVo.java
â”‚       â””â”€â”€ ...
â”œâ”€â”€ config/
â”‚   â””â”€â”€ WarmFlowConfig.java            # WarmFlow é…ç½®
â””â”€â”€ common/
    â”œâ”€â”€ ConditionalOnEnable.java       # æ¡ä»¶æ³¨è§£
    â”œâ”€â”€ constant/
    â”‚   â””â”€â”€ FlowConstant.java          # å¸¸é‡
    â””â”€â”€ enums/
        â”œâ”€â”€ TaskStatusEnum.java        # ä»»åŠ¡çŠ¶æ€
        â”œâ”€â”€ TaskAssigneeEnum.java      # åŠç†äººç±»å‹
        â”œâ”€â”€ TaskAssigneeType.java      # åŠç†äººç±»å‹æ‰©å±•
        â”œâ”€â”€ MessageTypeEnum.java       # æ¶ˆæ¯ç±»å‹
        â”œâ”€â”€ ButtonPermissionEnum.java  # æŒ‰é’®æƒé™
        â”œâ”€â”€ CopySettingEnum.java       # æŠ„é€è®¾ç½®
        â”œâ”€â”€ NodeExtEnum.java           # èŠ‚ç‚¹æ‰©å±•
        â””â”€â”€ VariablesEnum.java         # å˜é‡æšä¸¾
```

---

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### 1. FlowEngine æœåŠ¡è®¿é—®

```java
import org.dromara.warm.flow.core.FlowEngine;

// ä»»åŠ¡æœåŠ¡
FlowEngine.taskService()

// å®ä¾‹æœåŠ¡
FlowEngine.insService()

// æµç¨‹å®šä¹‰æœåŠ¡
FlowEngine.defService()

// èŠ‚ç‚¹æœåŠ¡
FlowEngine.nodeService()

// å†å²ä»»åŠ¡æœåŠ¡
FlowEngine.hisTaskService()

// ç”¨æˆ·æœåŠ¡
FlowEngine.userService()
```

### 2. ä»»åŠ¡çŠ¶æ€æšä¸¾

```java
package org.dromara.workflow.common.enums;

public enum TaskStatusEnum {
    CANCEL("cancel", "æ’¤é”€"),
    PASS("pass", "é€šè¿‡"),
    WAITING("waiting", "å¾…å®¡æ ¸"),
    INVALID("invalid", "ä½œåºŸ"),
    BACK("back", "é€€å›"),
    TERMINATION("termination", "ç»ˆæ­¢"),
    TRANSFER("transfer", "è½¬åŠ"),
    DEPUTE("depute", "å§”æ‰˜"),
    COPY("copy", "æŠ„é€"),
    SIGN("sign", "åŠ ç­¾"),
    SIGN_OFF("sign_off", "å‡ç­¾"),
    TIMEOUT("timeout", "è¶…æ—¶");

    private final String status;
    private final String desc;

    // åˆ¤æ–­çŠ¶æ€æ˜¯å¦ä¸ºé€šè¿‡æˆ–é€€å›
    public static boolean isPassOrBack(String status) {
        return PASS.getStatus().equals(status) || BACK.getStatus().equals(status);
    }
}
```

### 3. åŠç†äººç±»å‹æšä¸¾

> âš ï¸ **æ³¨æ„**ï¼šUSER å’Œ SPEL ç±»å‹æ²¡æœ‰å‰ç¼€ï¼

```java
package org.dromara.workflow.common.enums;

public enum TaskAssigneeEnum {
    USER("ç”¨æˆ·", ""),           // âš ï¸ ç”¨æˆ·æ²¡æœ‰å‰ç¼€
    ROLE("è§’è‰²", "role:"),
    DEPT("éƒ¨é—¨", "dept:"),
    POST("å²—ä½", "post:"),
    SPEL("SpELè¡¨è¾¾å¼", "");     // âš ï¸ SpEL æ²¡æœ‰å‰ç¼€ï¼Œé€šè¿‡ $ æˆ– # å¼€å¤´åˆ¤æ–­

    private final String desc;
    private final String code;

    // åˆ¤æ–­æ˜¯å¦ä¸º SPEL è¡¨è¾¾å¼ï¼ˆä»¥ $ æˆ– # å¼€å¤´ï¼‰
    public static boolean isSpelExpression(String value) {
        return StringUtils.startsWith(value, "$") || StringUtils.startsWith(value, "#");
    }
}
```

**storageId æ ¼å¼ç¤ºä¾‹**ï¼š
```
123           â†’ ç”¨æˆ·ID 123ï¼ˆæ— å‰ç¼€ï¼‰
role:456      â†’ è§’è‰²ID 456
dept:789      â†’ éƒ¨é—¨ID 789
post:101      â†’ å²—ä½ID 101
#{expression} â†’ SpELè¡¨è¾¾å¼ï¼ˆ# å¼€å¤´ï¼‰
${variable}   â†’ é»˜è®¤å˜é‡ç­–ç•¥ï¼ˆ$ å¼€å¤´ï¼‰
```

### 4. æµç¨‹å¸¸é‡

```java
package org.dromara.workflow.common.constant;

public interface FlowConstant {
    // åŸºç¡€å¸¸é‡
    String INITIATOR = "initiator";               // æµç¨‹å‘èµ·äºº
    String INITIATOR_DEPT_ID = "initiatorDeptId"; // å‘èµ·äººéƒ¨é—¨ID
    String BUSINESS_ID = "businessId";            // ä¸šåŠ¡ID
    String BUSINESS_CODE = "businessCode";        // ä¸šåŠ¡ç¼–ç 
    String SUBMIT = "submit";                     // ç”³è¯·äººæäº¤æ ‡è¯†

    // ä»»åŠ¡æ“ä½œç±»å‹
    String DELEGATE_TASK = "delegateTask";        // å§”æ‰˜ä»»åŠ¡
    String TRANSFER_TASK = "transferTask";        // è½¬åŠä»»åŠ¡
    String ADD_SIGNATURE = "addSignature";        // åŠ ç­¾
    String REDUCTION_SIGNATURE = "reductionSignature"; // å‡ç­¾

    // æŠ„é€ä¸æ¶ˆæ¯
    String FLOW_COPY_LIST = "flowCopyList";       // æŠ„é€äººåˆ—è¡¨
    String MESSAGE_TYPE = "messageType";          // æ¶ˆæ¯ç±»å‹
    String MESSAGE_NOTICE = "messageNotice";      // æ¶ˆæ¯å†…å®¹

    // è‡ªåŠ¨åŒ–é…ç½®
    String AUTO_PASS = "autoPass";                // è‡ªåŠ¨é€šè¿‡æ ‡è¯†

    // å¿½ç•¥æ ‡è¯†
    String VAR_IGNORE = "ignore";                 // å¿½ç•¥åŠç†æƒé™æ ¡éªŒ
}
```

---

## ğŸ“‹ å¸¸ç”¨æ“ä½œ

### 1. å¯åŠ¨æµç¨‹

```java
@Autowired
private IFlwTaskService flwTaskService;

// æ–¹å¼ä¸€ï¼šä½¿ç”¨ FlwTaskService
public void startProcess() {
    StartProcessBo bo = new StartProcessBo();
    bo.setFlowCode("leave_apply");           // æµç¨‹ç¼–ç 
    bo.setBusinessId("order_123");           // ä¸šåŠ¡ID
    bo.setVariables(Map.of("amount", 1000)); // æµç¨‹å˜é‡

    StartProcessReturnDTO result = flwTaskService.startWorkFlow(bo);
    Long instanceId = result.getProcessInstanceId();
    Long taskId = result.getTaskId();
}
```

```java
@Autowired
private WorkflowService workflowService;

// æ–¹å¼äºŒï¼šä½¿ç”¨ WorkflowServiceï¼ˆä¾›å…¶ä»–æ¨¡å—è°ƒç”¨ï¼‰
public void startProcess() {
    StartProcessDTO dto = new StartProcessDTO();
    dto.setFlowCode("leave_apply");
    dto.setBusinessId("order_123");
    dto.setVariables(Map.of("amount", 1000));

    StartProcessReturnDTO result = workflowService.startWorkFlow(dto);
}
```

### 2. åŠç†ä»»åŠ¡

```java
public void completeTask() {
    CompleteTaskBo bo = new CompleteTaskBo();
    bo.setTaskId(taskId);                    // ä»»åŠ¡ID
    bo.setMessage("åŒæ„");                    // å®¡æ‰¹æ„è§
    bo.setVariables(Map.of("approved", true)); // æµç¨‹å˜é‡

    // æŒ‡å®šä¸‹ä¸€èŠ‚ç‚¹åŠç†äººï¼ˆå¯é€‰ï¼‰
    bo.setAssigneeMap(Map.of(
        "pass:nodeCode", "user:1,user:2"
    ));

    flwTaskService.completeTask(bo);
}
```

### 3. é©³å›ä»»åŠ¡

```java
public void rejectTask() {
    BackProcessBo bo = new BackProcessBo();
    bo.setTaskId(taskId);
    bo.setNodeCode("apply_node");    // é©³å›åˆ°çš„èŠ‚ç‚¹
    bo.setMessage("èµ„æ–™ä¸å®Œæ•´");

    flwTaskService.backProcess(bo);
}
```

### 4. è½¬åŠ/å§”æ´¾

```java
// è½¬åŠï¼ˆè½¬ç»™ä»–äººåŠç†ï¼Œè‡ªå·±ä¸å†å‚ä¸ï¼‰
TaskOperationBo transferBo = new TaskOperationBo();
transferBo.setTaskId(taskId);
transferBo.setUserId("targetUserId");
transferBo.setMessage("è½¬äº¤å¤„ç†");
flwTaskService.taskOperation(transferBo, FlowConstant.TRANSFER_TASK);

// å§”æ´¾ï¼ˆå§”æ‰˜ä»–äººä»£åŠï¼Œæœ€ç»ˆè¿˜éœ€è‡ªå·±ç¡®è®¤ï¼‰
TaskOperationBo deputeBo = new TaskOperationBo();
deputeBo.setTaskId(taskId);
deputeBo.setUserId("targetUserId");
deputeBo.setMessage("è¯·ååŠ©å¤„ç†");
flwTaskService.taskOperation(deputeBo, FlowConstant.DELEGATE_TASK);
```

### 5. åŠ ç­¾/å‡ç­¾

```java
// åŠ ç­¾ï¼ˆå¢åŠ åŠç†äººï¼‰
TaskOperationBo addBo = new TaskOperationBo();
addBo.setTaskId(taskId);
addBo.setUserIds(List.of("user1", "user2"));
addBo.setMessage("å¢åŠ ä¼šç­¾äººå‘˜");
flwTaskService.taskOperation(addBo, FlowConstant.ADD_SIGNATURE);

// å‡ç­¾ï¼ˆå‡å°‘åŠç†äººï¼‰
TaskOperationBo reduceBo = new TaskOperationBo();
reduceBo.setTaskId(taskId);
reduceBo.setUserIds(List.of("user1"));
reduceBo.setMessage("å‡å°‘ä¼šç­¾äººå‘˜");
flwTaskService.taskOperation(reduceBo, FlowConstant.REDUCTION_SIGNATURE);
```

### 6. æŸ¥è¯¢å¾…åŠ/å·²åŠä»»åŠ¡

```java
@Autowired
private IFlwTaskService flwTaskService;

// æŸ¥è¯¢å½“å‰ç”¨æˆ·å¾…åŠä»»åŠ¡
public TableDataInfo<FlowTaskVo> getTodoList(FlowTaskBo bo, PageQuery pageQuery) {
    return flwTaskService.pageByTaskWait(bo, pageQuery);
}

// æŸ¥è¯¢å½“å‰ç”¨æˆ·å·²åŠä»»åŠ¡
public TableDataInfo<FlowHisTaskVo> getDoneList(FlowTaskBo bo, PageQuery pageQuery) {
    return flwTaskService.pageByTaskFinish(bo, pageQuery);
}

// æŸ¥è¯¢æ‰€æœ‰å¾…åŠä»»åŠ¡ï¼ˆç®¡ç†å‘˜ï¼‰
public TableDataInfo<FlowTaskVo> getAllTodoList(FlowTaskBo bo, PageQuery pageQuery) {
    return flwTaskService.pageByAllTaskWait(bo, pageQuery);
}

// æŸ¥è¯¢æŠ„é€ä»»åŠ¡
public TableDataInfo<FlowTaskVo> getCopyList(FlowTaskBo bo, PageQuery pageQuery) {
    return flwTaskService.pageByTaskCopy(bo, pageQuery);
}
```

---

## ğŸ¯ ä¸šåŠ¡é›†æˆ

### 1. ç›‘å¬æµç¨‹äº‹ä»¶

> äº‹ä»¶ç±»ä½äº `org.dromara.common.core.domain.event` åŒ…

```java
import org.springframework.context.event.EventListener;
import org.dromara.common.core.domain.event.ProcessEvent;
import org.dromara.common.core.domain.event.ProcessTaskEvent;
import org.dromara.common.core.domain.event.ProcessDeleteEvent;

@Component
public class OrderWorkflowListener {

    /**
     * ç›‘å¬æµç¨‹çŠ¶æ€å˜æ›´
     */
    @EventListener(condition = "#event.flowCode == 'order_approve'")
    public void onProcessEvent(ProcessEvent event) {
        String businessId = event.getBusinessId();
        String status = event.getStatus();
        boolean isSubmit = event.isSubmit();

        // ç”³è¯·äººæäº¤
        if (isSubmit) {
            orderService.updateStatus(businessId, "PENDING");
            return;
        }

        // æ ¹æ®æµç¨‹çŠ¶æ€æ›´æ–°ä¸šåŠ¡æ•°æ®
        switch (status) {
            case "finish" -> orderService.updateStatus(businessId, "APPROVED");
            case "back" -> orderService.updateStatus(businessId, "REJECTED");
            case "cancel" -> orderService.updateStatus(businessId, "CANCELLED");
            case "termination" -> orderService.updateStatus(businessId, "TERMINATED");
            case "invalid" -> orderService.updateStatus(businessId, "INVALID");
        }
    }

    /**
     * ç›‘å¬ä»»åŠ¡åˆ›å»ºï¼ˆå‘é€é€šçŸ¥ï¼‰
     */
    @EventListener(condition = "#event.flowCode == 'order_approve'")
    public void onTaskCreated(ProcessTaskEvent event) {
        Long taskId = event.getTaskId();
        String businessId = event.getBusinessId();
        // è·å–å¾…åŠäººå¹¶å‘é€é€šçŸ¥
        sendNotification(taskId);
    }

    /**
     * ç›‘å¬æµç¨‹åˆ é™¤
     */
    @EventListener(condition = "#event.flowCode == 'order_approve'")
    public void onProcessDeleted(ProcessDeleteEvent event) {
        String businessId = event.getBusinessId();
        // æ¸…ç†ä¸šåŠ¡ç›¸å…³æ•°æ®
        orderService.cleanupWorkflowData(businessId);
    }
}
```

### 2. äº‹ä»¶ç±»å‹è¯´æ˜

| äº‹ä»¶ç±» | è§¦å‘æ—¶æœº | ä¸»è¦å­—æ®µ |
|-------|---------|---------|
| `ProcessEvent` | æµç¨‹çŠ¶æ€å˜æ›´ï¼ˆæäº¤ã€é€šè¿‡ã€é©³å›ã€æ’¤é”€ã€ç»ˆæ­¢ã€ä½œåºŸã€å®Œæˆï¼‰ | flowCode, businessId, status, submit |
| `ProcessTaskEvent` | ä»»åŠ¡åˆ›å»ºæ—¶ | flowCode, businessId, taskId, nodeCode |
| `ProcessDeleteEvent` | æµç¨‹åˆ é™¤æ—¶ | flowCode, businessId |

### 3. å®Œæ•´ä¸šåŠ¡é›†æˆç¤ºä¾‹

```java
@Service
@RequiredArgsConstructor
public class LeaveServiceImpl implements ILeaveService {

    private final LeaveMapper baseMapper;  // âœ… ä¸‰å±‚æ¶æ„ï¼Œç›´æ¥æ³¨å…¥ Mapper
    private final WorkflowService workflowService;

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean submitLeave(LeaveBo bo) {
        // 1. ä¿å­˜ä¸šåŠ¡æ•°æ®
        Leave leave = MapstructUtils.convert(bo, Leave.class);  // âœ… ä½¿ç”¨ MapstructUtils
        baseMapper.insert(leave);

        // 2. å¯åŠ¨æµç¨‹
        StartProcessDTO startProcess = new StartProcessDTO();
        startProcess.setBusinessId(String.valueOf(leave.getId()));
        startProcess.setFlowCode("leave");
        startProcess.setVariables(Map.of(
            "days", leave.getDays(),
            "reason", leave.getReason()
        ));

        StartProcessReturnDTO result = workflowService.startWorkFlow(startProcess);

        // 3. åŠç†ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼ˆç”³è¯·äººèŠ‚ç‚¹ï¼‰
        workflowService.completeTask(result.getTaskId(), "æäº¤ç”³è¯·");

        return true;
    }
}
```

---

## ğŸ“¡ æ¶ˆæ¯é€šçŸ¥

### é€šçŸ¥ç±»å‹

```java
package org.dromara.workflow.common.enums;

public enum MessageTypeEnum {
    SYSTEM_MESSAGE("system", "ç³»ç»Ÿæ¶ˆæ¯ï¼ˆSSEæ¨é€ï¼‰"),
    EMAIL_MESSAGE("email", "é‚®ä»¶"),
    SMS_MESSAGE("sms", "çŸ­ä¿¡");
}
```

### é…ç½®æ¶ˆæ¯é€šçŸ¥

åœ¨æµç¨‹å˜é‡ä¸­è®¾ç½®ï¼š

```java
Map<String, Object> variable = new HashMap<>();
variable.put(FlowConstant.MESSAGE_TYPE, List.of("system", "email"));  // SSE + é‚®ä»¶
variable.put(FlowConstant.MESSAGE_NOTICE, "æ‚¨æœ‰æ–°çš„å®¡æ‰¹ä»»åŠ¡");
```

---

## ğŸŒ API æ¥å£

### ä»»åŠ¡ç®¡ç† (/workflow/task)

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/startWorkFlow` | POST | å¯åŠ¨æµç¨‹ |
| `/completeTask` | POST | åŠç†ä»»åŠ¡ |
| `/pageByTaskWait` | GET | å½“å‰ç”¨æˆ·å¾…åŠä»»åŠ¡ |
| `/pageByTaskFinish` | GET | å½“å‰ç”¨æˆ·å·²åŠä»»åŠ¡ |
| `/pageByAllTaskWait` | GET | æ‰€æœ‰å¾…åŠä»»åŠ¡ |
| `/pageByAllTaskFinish` | GET | æ‰€æœ‰å·²åŠä»»åŠ¡ |
| `/pageByTaskCopy` | GET | æŠ„é€ä»»åŠ¡åˆ—è¡¨ |
| `/getTask/{taskId}` | GET | è·å–ä»»åŠ¡è¯¦æƒ… |
| `/getNextNodeList` | POST | è·å–ä¸‹ä¸€èŠ‚ç‚¹åˆ—è¡¨ |
| `/backProcess` | POST | é©³å›ä»»åŠ¡ |
| `/getBackTaskNode/{definitionId}/{nodeCode}` | GET | è·å–å¯é©³å›èŠ‚ç‚¹ |
| `/terminationTask` | POST | ç»ˆæ­¢æµç¨‹ |
| `/taskOperation/{type}` | POST | ä»»åŠ¡æ“ä½œï¼ˆå§”æ‰˜/è½¬åŠ/åŠ ç­¾/å‡ç­¾ï¼‰ |
| `/currentTaskAllUser/{taskId}` | GET | è·å–ä»»åŠ¡æ‰€æœ‰åŠç†äºº |
| `/updateAssignee/{userId}` | PUT | ä¿®æ”¹ä»»åŠ¡åŠç†äºº |
| `/urgeTask` | POST | å‚¬åŠä»»åŠ¡ |

### å®ä¾‹ç®¡ç† (/workflow/instance)

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/pageRunningInstance` | GET | è¿è¡Œä¸­çš„æµç¨‹å®ä¾‹ |
| `/pageFinishInstance` | GET | å·²å®Œæˆçš„æµç¨‹å®ä¾‹ |
| `/pageCurrentInstance` | GET | å½“å‰ç”¨æˆ·å‘èµ·çš„æµç¨‹ |
| `/queryByBusinessId/{businessId}` | GET | æ ¹æ®ä¸šåŠ¡IDæŸ¥è¯¢å®ä¾‹ |
| `/flowHisTaskList/{businessId}` | GET | è·å–å®¡æ‰¹å†å² |
| `/cancelProcessApply` | POST | æ’¤é”€æµç¨‹ |
| `/processInvalid` | POST | ä½œåºŸæµç¨‹ |
| `/deleteInstance` | DELETE | åˆ é™¤æµç¨‹å®ä¾‹ |
| `/deleteHisInstance` | DELETE | åˆ é™¤å·²å®Œæˆçš„æµç¨‹å®ä¾‹ |
| `/instanceVariable/{instanceId}` | GET | è·å–æµç¨‹å˜é‡ |
| `/updateVariable` | PUT | æ›´æ–°æµç¨‹å˜é‡ |

### æµç¨‹å®šä¹‰ (/workflow/definition)

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/pageDefinitions` | GET | å·²å‘å¸ƒçš„æµç¨‹å®šä¹‰ |
| `/pageUnPublishDefinitions` | GET | æœªå‘å¸ƒçš„æµç¨‹å®šä¹‰ |
| `/publish/{id}` | PUT | å‘å¸ƒæµç¨‹å®šä¹‰ |
| `/importJson` | POST | å¯¼å…¥æµç¨‹å®šä¹‰ |
| `/exportDef/{id}` | GET | å¯¼å‡ºæµç¨‹å®šä¹‰ |
| `/removeDef` | DELETE | åˆ é™¤æµç¨‹å®šä¹‰ |

### æµç¨‹åˆ†ç±» (/workflow/category)

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/list` | GET | åˆ†é¡µæŸ¥è¯¢åˆ†ç±» |
| `/{id}` | GET | è·å–åˆ†ç±»è¯¦æƒ… |
| `` | POST | æ–°å¢åˆ†ç±» |
| `` | PUT | ä¿®æ”¹åˆ†ç±» |
| `/{ids}` | DELETE | åˆ é™¤åˆ†ç±» |

---

## ğŸ”„ å…¨å±€ç›‘å¬å™¨

`WorkflowGlobalListener` å®ç° `GlobalListener` æ¥å£ï¼š

```java
@Component
public class WorkflowGlobalListener implements GlobalListener {

    @Override
    public void create(ListenerVariable listenerVariable) {
        // ä»»åŠ¡åˆ›å»ºæ—¶æ‰§è¡Œ
    }

    @Override
    public void start(ListenerVariable listenerVariable) {
        // ä»»åŠ¡å¼€å§‹åŠç†æ—¶æ‰§è¡Œ
        // å¤„ç†ï¼šæŠ„é€è®¾ç½®ã€è‡ªå®šä¹‰å˜é‡
    }

    @Override
    public void assignment(ListenerVariable listenerVariable) {
        // åˆ†æ´¾ç›‘å¬å™¨ï¼ŒåŠ¨æ€ä¿®æ”¹å¾…åŠä»»åŠ¡åŠç†äºº
        // å¤„ç†ï¼šæŒ‡å®šåŠç†äººã€ç”³è¯·èŠ‚ç‚¹åŠç†äººè®¾ç½®
    }

    @Override
    public void finish(ListenerVariable listenerVariable) {
        // ä»»åŠ¡å®Œæˆåæ‰§è¡Œ
        // å¤„ç†ï¼šçŠ¶æ€æ›´æ–°ã€æ¶ˆæ¯é€šçŸ¥ã€æŠ„é€ã€äº‹ä»¶å‘å¸ƒ
    }
}
```

---

## âœ… æ£€æŸ¥æ¸…å•

- [ ] æ˜¯å¦æ­£ç¡®ä½¿ç”¨ `FlowEngine` è®¿é—®æ ¸å¿ƒæœåŠ¡ï¼Ÿ
- [ ] æ˜¯å¦ä½¿ç”¨ `ProcessEvent`/`ProcessTaskEvent` ç›‘å¬æµç¨‹çŠ¶æ€å˜æ›´ï¼Ÿ
- [ ] æ˜¯å¦æ­£ç¡®é…ç½®åŠç†äººï¼ˆæ³¨æ„ï¼šç”¨æˆ·IDæ— å‰ç¼€ï¼Œè§’è‰²/éƒ¨é—¨/å²—ä½æœ‰å‰ç¼€ï¼‰ï¼Ÿ
- [ ] æ˜¯å¦åœ¨ä¸šåŠ¡æ¨¡å—ä¸­æ­£ç¡®é›†æˆ `WorkflowService`ï¼Ÿ
- [ ] æ˜¯å¦å¤„ç†äº†æµç¨‹å„çŠ¶æ€ï¼ˆé€šè¿‡ã€é©³å›ã€æ’¤é”€ã€ç»ˆæ­¢ï¼‰çš„ä¸šåŠ¡é€»è¾‘ï¼Ÿ
- [ ] æ˜¯å¦ä½¿ç”¨ `MapstructUtils.convert()` è¿›è¡Œå¯¹è±¡è½¬æ¢ï¼Ÿ
- [ ] Service æ˜¯å¦ç›´æ¥æ³¨å…¥ Mapperï¼ˆæ—  DAO å±‚ï¼‰ï¼Ÿ

---

## â“ å¸¸è§é—®é¢˜

### Q1: ç”¨æˆ·IDå’Œè§’è‰²IDåœ¨åŠç†äººé…ç½®ä¸­çš„åŒºåˆ«ï¼Ÿ

```java
// âœ… ç”¨æˆ·ID - æ— å‰ç¼€
"123"           // ç›´æ¥æ˜¯ç”¨æˆ·ID

// âœ… è§’è‰²ID - æœ‰ role: å‰ç¼€
"role:456"      // è§’è‰²ID

// âœ… éƒ¨é—¨ID - æœ‰ dept: å‰ç¼€
"dept:789"      // éƒ¨é—¨ID

// âœ… å²—ä½ID - æœ‰ post: å‰ç¼€
"post:101"      // å²—ä½ID
```

### Q2: å¦‚ä½•åˆ¤æ–­æ˜¯å¦ä¸º SpEL è¡¨è¾¾å¼ï¼Ÿ

```java
// SpEL è¡¨è¾¾å¼ä»¥ # æˆ– $ å¼€å¤´
TaskAssigneeEnum.isSpelExpression("#{initiator}")  // true
TaskAssigneeEnum.isSpelExpression("${deptLeader}") // true
TaskAssigneeEnum.isSpelExpression("user:123")      // false
```

### Q3: å¦‚ä½•å¿½ç•¥åŠç†æƒé™æ ¡éªŒï¼Ÿ

```java
Map<String, Object> variable = new HashMap<>();
variable.put(FlowConstant.VAR_IGNORE, true);  // å¿½ç•¥åŠç†æƒé™æ ¡éªŒ
```

### Q4: å¦‚ä½•å®ç°è‡ªåŠ¨å®¡æ‰¹ï¼Ÿ

åœ¨æµç¨‹å˜é‡ä¸­è®¾ç½® `autoPass: true`ï¼Œå½“åŠç†äººæ˜¯å‘èµ·äººè‡ªå·±æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é€šè¿‡è¯¥èŠ‚ç‚¹ã€‚

### Q5: å¦‚ä½•åŠ¨æ€æŒ‡å®šåŠç†äººï¼Ÿ

1. ä½¿ç”¨æµç¨‹å˜é‡ï¼š`variables.put("nextAssignee", userId)`
2. ä½¿ç”¨ SpEL è¡¨è¾¾å¼ï¼šé…ç½®åŠç†äººä¸º `#{nextAssignee}`
3. åœ¨åŠç†æ—¶æŒ‡å®šï¼šé€šè¿‡ `assigneeMap` æŒ‡å®šä¸‹ä¸€æ­¥åŠç†äºº

---

## ğŸ¯ æœ€ä½³å®è·µ

### âœ… åº”è¯¥åš

- âœ… ä¸šåŠ¡ID ä½¿ç”¨é›ªèŠ±IDï¼Œç¡®ä¿å”¯ä¸€æ€§
- âœ… æµç¨‹ç¼–ç ä½¿ç”¨æœ‰æ„ä¹‰çš„è‹±æ–‡å‘½åï¼ˆå¦‚ `leave`ã€`expense`ï¼‰
- âœ… é€šè¿‡äº‹ä»¶ç›‘å¬æœºåˆ¶åŒæ­¥ä¸šåŠ¡çŠ¶æ€
- âœ… ä½¿ç”¨ `@Transactional` ç¡®ä¿ä¸šåŠ¡æ•°æ®å’Œæµç¨‹æ•°æ®çš„ä¸€è‡´æ€§
- âœ… ä½¿ç”¨ `MapstructUtils.convert()` è¿›è¡Œå¯¹è±¡è½¬æ¢
- âœ… Service å±‚ç›´æ¥æ³¨å…¥ Mapperï¼ˆä¸‰å±‚æ¶æ„ï¼‰

### âŒ ä¸åº”è¯¥åš

- âŒ ä¸è¦åœ¨ä¸šåŠ¡ä»£ç ä¸­ç›´æ¥æ“ä½œ WarmFlow çš„åº•å±‚ API
- âŒ ä¸è¦åœ¨æµç¨‹å˜é‡ä¸­å­˜å‚¨æ•æ„Ÿä¿¡æ¯
- âŒ ä¸è¦é¢‘ç¹æŸ¥è¯¢æµç¨‹çŠ¶æ€ï¼Œä½¿ç”¨äº‹ä»¶é©±åŠ¨
- âŒ ä¸è¦ä½¿ç”¨ BeanUtils è¿›è¡Œå¯¹è±¡è½¬æ¢
- âŒ ä¸è¦åˆ›å»º DAO å±‚ï¼ˆæœ¬é¡¹ç›®æ˜¯ä¸‰å±‚æ¶æ„ï¼‰

---

## ğŸ“š å‚è€ƒå®ç°

| ç±»å‹ | å‚è€ƒæ–‡ä»¶ |
|------|---------|
| è¯·å‡ç¤ºä¾‹ Controller | `org.dromara.workflow.controller.TestLeaveController` |
| è¯·å‡ç¤ºä¾‹ Service | `org.dromara.workflow.service.impl.TestLeaveServiceImpl` |
| è¯·å‡ç¤ºä¾‹ Entity | `org.dromara.workflow.domain.TestLeave` |
| ä»»åŠ¡æœåŠ¡å®ç° | `org.dromara.workflow.service.impl.FlwTaskServiceImpl` |
| å…¨å±€ç›‘å¬å™¨ | `org.dromara.workflow.listener.WorkflowGlobalListener` |
| äº‹ä»¶å¤„ç†å™¨ | `org.dromara.workflow.handler.FlowProcessEventHandler` |

<!-- æŠ“è›™å¸ˆ -->
